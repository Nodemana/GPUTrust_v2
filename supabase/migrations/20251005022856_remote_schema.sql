revoke delete on table "public"."avg_gpu_benchmarks" from "anon";

revoke insert on table "public"."avg_gpu_benchmarks" from "anon";

revoke references on table "public"."avg_gpu_benchmarks" from "anon";

revoke select on table "public"."avg_gpu_benchmarks" from "anon";

revoke trigger on table "public"."avg_gpu_benchmarks" from "anon";

revoke truncate on table "public"."avg_gpu_benchmarks" from "anon";

revoke update on table "public"."avg_gpu_benchmarks" from "anon";

revoke delete on table "public"."avg_gpu_benchmarks" from "authenticated";

revoke insert on table "public"."avg_gpu_benchmarks" from "authenticated";

revoke references on table "public"."avg_gpu_benchmarks" from "authenticated";

revoke select on table "public"."avg_gpu_benchmarks" from "authenticated";

revoke trigger on table "public"."avg_gpu_benchmarks" from "authenticated";

revoke truncate on table "public"."avg_gpu_benchmarks" from "authenticated";

revoke update on table "public"."avg_gpu_benchmarks" from "authenticated";

revoke delete on table "public"."avg_gpu_benchmarks" from "service_role";

revoke insert on table "public"."avg_gpu_benchmarks" from "service_role";

revoke references on table "public"."avg_gpu_benchmarks" from "service_role";

revoke select on table "public"."avg_gpu_benchmarks" from "service_role";

revoke trigger on table "public"."avg_gpu_benchmarks" from "service_role";

revoke truncate on table "public"."avg_gpu_benchmarks" from "service_role";

revoke update on table "public"."avg_gpu_benchmarks" from "service_role";

revoke delete on table "public"."gpu_benchmark_runtime" from "anon";

revoke insert on table "public"."gpu_benchmark_runtime" from "anon";

revoke references on table "public"."gpu_benchmark_runtime" from "anon";

revoke select on table "public"."gpu_benchmark_runtime" from "anon";

revoke trigger on table "public"."gpu_benchmark_runtime" from "anon";

revoke truncate on table "public"."gpu_benchmark_runtime" from "anon";

revoke update on table "public"."gpu_benchmark_runtime" from "anon";

revoke delete on table "public"."gpu_benchmark_runtime" from "authenticated";

revoke insert on table "public"."gpu_benchmark_runtime" from "authenticated";

revoke references on table "public"."gpu_benchmark_runtime" from "authenticated";

revoke select on table "public"."gpu_benchmark_runtime" from "authenticated";

revoke trigger on table "public"."gpu_benchmark_runtime" from "authenticated";

revoke truncate on table "public"."gpu_benchmark_runtime" from "authenticated";

revoke update on table "public"."gpu_benchmark_runtime" from "authenticated";

revoke delete on table "public"."gpu_benchmark_runtime" from "service_role";

revoke insert on table "public"."gpu_benchmark_runtime" from "service_role";

revoke references on table "public"."gpu_benchmark_runtime" from "service_role";

revoke select on table "public"."gpu_benchmark_runtime" from "service_role";

revoke trigger on table "public"."gpu_benchmark_runtime" from "service_role";

revoke truncate on table "public"."gpu_benchmark_runtime" from "service_role";

revoke update on table "public"."gpu_benchmark_runtime" from "service_role";

revoke delete on table "public"."gpu_benchmarks" from "anon";

revoke insert on table "public"."gpu_benchmarks" from "anon";

revoke references on table "public"."gpu_benchmarks" from "anon";

revoke select on table "public"."gpu_benchmarks" from "anon";

revoke trigger on table "public"."gpu_benchmarks" from "anon";

revoke truncate on table "public"."gpu_benchmarks" from "anon";

revoke update on table "public"."gpu_benchmarks" from "anon";

revoke delete on table "public"."gpu_benchmarks" from "authenticated";

revoke insert on table "public"."gpu_benchmarks" from "authenticated";

revoke references on table "public"."gpu_benchmarks" from "authenticated";

revoke select on table "public"."gpu_benchmarks" from "authenticated";

revoke trigger on table "public"."gpu_benchmarks" from "authenticated";

revoke truncate on table "public"."gpu_benchmarks" from "authenticated";

revoke update on table "public"."gpu_benchmarks" from "authenticated";

revoke delete on table "public"."gpu_benchmarks" from "service_role";

revoke insert on table "public"."gpu_benchmarks" from "service_role";

revoke references on table "public"."gpu_benchmarks" from "service_role";

revoke select on table "public"."gpu_benchmarks" from "service_role";

revoke trigger on table "public"."gpu_benchmarks" from "service_role";

revoke truncate on table "public"."gpu_benchmarks" from "service_role";

revoke update on table "public"."gpu_benchmarks" from "service_role";

revoke delete on table "public"."gpu_listings" from "anon";

revoke insert on table "public"."gpu_listings" from "anon";

revoke references on table "public"."gpu_listings" from "anon";

revoke select on table "public"."gpu_listings" from "anon";

revoke trigger on table "public"."gpu_listings" from "anon";

revoke truncate on table "public"."gpu_listings" from "anon";

revoke update on table "public"."gpu_listings" from "anon";

revoke delete on table "public"."gpu_listings" from "authenticated";

revoke insert on table "public"."gpu_listings" from "authenticated";

revoke references on table "public"."gpu_listings" from "authenticated";

revoke select on table "public"."gpu_listings" from "authenticated";

revoke trigger on table "public"."gpu_listings" from "authenticated";

revoke truncate on table "public"."gpu_listings" from "authenticated";

revoke update on table "public"."gpu_listings" from "authenticated";

revoke delete on table "public"."gpu_listings" from "service_role";

revoke insert on table "public"."gpu_listings" from "service_role";

revoke references on table "public"."gpu_listings" from "service_role";

revoke select on table "public"."gpu_listings" from "service_role";

revoke trigger on table "public"."gpu_listings" from "service_role";

revoke truncate on table "public"."gpu_listings" from "service_role";

revoke update on table "public"."gpu_listings" from "service_role";

revoke delete on table "public"."users" from "anon";

revoke insert on table "public"."users" from "anon";

revoke references on table "public"."users" from "anon";

revoke select on table "public"."users" from "anon";

revoke trigger on table "public"."users" from "anon";

revoke truncate on table "public"."users" from "anon";

revoke update on table "public"."users" from "anon";

revoke delete on table "public"."users" from "authenticated";

revoke insert on table "public"."users" from "authenticated";

revoke references on table "public"."users" from "authenticated";

revoke select on table "public"."users" from "authenticated";

revoke trigger on table "public"."users" from "authenticated";

revoke truncate on table "public"."users" from "authenticated";

revoke update on table "public"."users" from "authenticated";

revoke delete on table "public"."users" from "service_role";

revoke insert on table "public"."users" from "service_role";

revoke references on table "public"."users" from "service_role";

revoke select on table "public"."users" from "service_role";

revoke trigger on table "public"."users" from "service_role";

revoke truncate on table "public"."users" from "service_role";

revoke update on table "public"."users" from "service_role";

alter table "public"."avg_gpu_benchmarks" drop constraint "avg_gpu_benchmarks_pkey";

drop index if exists "public"."avg_gpu_benchmarks_pkey";

alter table "public"."avg_gpu_benchmarks" drop column "gpu_AIB_partner";

alter table "public"."avg_gpu_benchmarks" add column "gpu_aib_partner" text not null;

alter table "public"."gpu_benchmarks" drop column "gpu_AIB_partner";

alter table "public"."gpu_benchmarks" add column "gpu_aib_partner" text;

CREATE UNIQUE INDEX avg_gpu_benchmarks_pkey ON public.avg_gpu_benchmarks USING btree (gpu_aib_partner, gpu_model, gpu_arch, vram_gb);

alter table "public"."avg_gpu_benchmarks" add constraint "avg_gpu_benchmarks_pkey" PRIMARY KEY using index "avg_gpu_benchmarks_pkey";

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.generate_gpu_benchmark_avgs()
 RETURNS void
 LANGUAGE plpgsql
AS $function$BEGIN
  INSERT INTO public.avg_gpu_benchmarks AS avg_tbl (
    gpu_aib_partner,
    gpu_model,
    gpu_arch,
    vram_gb,
    avg_fp16_flops,
    avg_fp32_flops,
    avg_fp64_flops,
    avg_tensor_flops_fp16,
    avg_tensor_flops_fp32,
    avg_tensor_flops_fp64,
    avg_d2d_mem_bandwidth,
    avg_h2d_mem_bandwidth,
    avg_d2h_mem_bandwidth,
    avg_max_temp,
    avg_avg_temp,
    avg_max_pwr_draw,
    avg_avg_pwr_draw
  )
  SELECT
    b.gpu_aib_partner,
    b.gpu_model,
    b.gpu_arch,
    b.vram_gb,
    AVG(b.fp16_flops) AS avg_fp16_flops,
    AVG(b.fp32_flops) AS avg_fp32_flops,
    AVG(b.fp64_flops) AS avg_fp64_flops,
    AVG(b.tensor_flops_fp16) AS avg_tensor_flops_fp16,
    AVG(b.tensor_flops_bf16) AS avg_tensor_flops_fp32,  -- or map properly if needed
    AVG(b.tensor_flops_tf32) AS avg_tensor_flops_fp64,  -- adjust if different
    AVG(b.d2d_mem_bandwidth) AS avg_d2d_mem_bandwidth,
    AVG(b.h2d_mem_bandwidth) AS avg_h2d_mem_bandwidth,
    AVG(b.d2h_mem_bandwidth) AS avg_d2h_mem_bandwidth,
    AVG(b.max_temp) AS avg_max_temp,
    AVG(b.avg_temp) AS avg_avg_temp,
    AVG(b.max_pwr_draw) AS avg_max_pwr_draw,
    AVG(b.avg_pwr_draw) AS avg_avg_pwr_draw
  FROM public.gpu_benchmarks b
  GROUP BY b.gpu_aib_partner, b.gpu_model, b.gpu_arch, b.vram_gb
  ON CONFLICT (vram_gb, gpu_aib_partner, gpu_model, gpu_arch)
  DO UPDATE SET
    avg_fp16_flops = EXCLUDED.avg_fp16_flops,
    avg_fp32_flops = EXCLUDED.avg_fp32_flops,
    avg_fp64_flops = EXCLUDED.avg_fp64_flops,
    avg_tensor_flops_fp16 = EXCLUDED.avg_tensor_flops_fp16,
    avg_tensor_flops_fp32 = EXCLUDED.avg_tensor_flops_fp32,
    avg_tensor_flops_fp64 = EXCLUDED.avg_tensor_flops_fp64,
    avg_d2d_mem_bandwidth = EXCLUDED.avg_d2d_mem_bandwidth,
    avg_h2d_mem_bandwidth = EXCLUDED.avg_h2d_mem_bandwidth,
    avg_d2h_mem_bandwidth = EXCLUDED.avg_d2h_mem_bandwidth,
    avg_max_temp = EXCLUDED.avg_max_temp,
    avg_avg_temp = EXCLUDED.avg_avg_temp,
    avg_max_pwr_draw = EXCLUDED.avg_max_pwr_draw,
    avg_avg_pwr_draw = EXCLUDED.avg_avg_pwr_draw;
END;$function$
;



